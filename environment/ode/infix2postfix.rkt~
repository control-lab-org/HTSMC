#lang racket
(provide
 fixed-2-infix
 reduce-sexp        
 )

(provide infix-2-postfix
         )

(define (make-unary op arg)
  (list op (list arg)))
  ;(cons op  arg))

(define (make-binary op arg0 arg1)
  (list  arg0 op arg1))

(define (print-args op args-list)
  (let ([arg-0 (car args-list)]
        [arg-1 (cdr args-list)])
    (if (null? arg-1)
        (make-unary op (infix-2-postfix arg-0))
        (make-binary op
                     (infix-2-postfix arg-0)
                     (infix-2-postfix (car arg-1)))
        )))

(define (infix-2-postfix sexp)
  (if (cons? sexp)
      (if (null? (cdr sexp) )
          (car sexp)
          (print-args (car sexp) (cdr sexp)))
      (if(number? sexp)
         (list sexp)
         sexp))
  )

(define (round-float number)
  (/  (round (* 1000 number)) 1000))

(define (check-arg arg)
  (if (number?  arg)
      (if (< arg 0)
          (list (round-float  arg))
          (round-float  arg))
      arg))

(define (one? something)
  (equal? something 1))

(define (two? something)
  (equal? something 2))

(define (three? something)
  (equal? something 3))

(define (sign num)
  (cond
    [(< num 0) -1.0]
    [(equal? num 0) 0]
    [else      1.0]))

  

(define (replace-syms quo)
  (cond
    [(equal? quo '-) -]
    [(equal? quo '+) +]
    [(equal? quo '*) *]
    [(equal? quo '/) /]
    [(equal? quo 'tanh) tanh]
    [(equal? quo 'sign) sign]

    ))


(define (parse-unary sexp)
  (let* ([op (first sexp)]
         [arg0 (fixed-2-infix(second sexp))]
         )
    (if (number? arg0)
        (check-arg ((replace-syms op) arg0))
        (list op (list  arg0))))) 


(define (parse-binary sexp)
  (let* ([op (first sexp)]
         [arg0 (fixed-2-infix (second sexp))]
         [arg1 (fixed-2-infix (third sexp))])
    (if (and (number? arg0) (number? arg1))
        (check-arg  ((replace-syms op) arg0 arg1))
        ;(list (p-i arg0) op  (p-i arg1))
        (list (check-arg arg0) op  (check-arg arg1))
        )))


(define (parse sexp)
  (let ([len (length sexp)])
    (cond
      [(zero? len) 'zero]
      [(one? len) (check-arg sexp)]
      [(two? len)  (parse-unary sexp)]
      [(three? len) (parse-binary sexp) ]
      [else 'error])
      ))

(define (fixed-2-infix sexp)
  (cond
    [(list? sexp)  (parse sexp)]
    [(number? sexp) (round-float sexp)]
    [else sexp]))



(define (parse-unary-fix sexp)
  (let* ([op (first sexp)]
         [arg0 (reduce-sexp (second sexp))]
         )
    (if (number? arg0)
        ((replace-syms op) arg0)
        (list op (list  arg0))))) 
    
(define (parse-binary-fix sexp)
  (let* ([op (first sexp)]
         [arg0 (reduce-sexp (second sexp))]
         [arg1 (reduce-sexp (third sexp))])
    (if (and (number? arg0) (number? arg1))
        ((replace-syms op) arg0 arg1)
        (list op arg0  arg1)
        )))

(define (parse-fix sexp)
  (let ([len (length sexp)])
    (cond
      [(zero? len) 'zero]
      [(one? len) (check-arg sexp)]
      [(two? len)  (parse-unary-fix sexp)]
      [(three? len) (parse-binary-fix sexp) ]
      [else 'error])
      ))


(define (reduce-sexp sexp)
  (cond
    [(list? sexp)  (parse-fix sexp)]
    [(number? sexp) (round-float sexp)]
    [else sexp]))



(define (make-fxu op arg)
  (list op (list arg)))
(define (make-fxb op arg0 arg1)
  (list op arg0 arg1))

(define (cut-integral sexp)
  (if ( eq? 'integral (first sexp))
      (cadr sexp)
      null))

(define (cut-integrals sexp)
   (let ([len (length sexp)])
    (cond
      [(zero? len) 'zero]
      [(one? len)  null]
      [(two? len)   sexp]
      [(three? len) (parse-binary-fix sexp) ]
      [else 'error])
      ))

;; (define (extract-integral-fnc sexp)
;;   (let ([op   (car sexp)]
;;         [args (cdr sexp)]
;;         )
;;     (if (one? (length args))
;;         (extract-integral-fnc (cadr sexp))
;;         (list (extract-integral-fnc (cadr sexp))
;;               (extract-integral-fnc (cadr sexp))))
;;     ))

;; (define t '(+ (- -16.647842075384954) 4.610156751915959))
;; (define t2 '(+ (- -16.647842075384954) e))
;; (define t3 '(* (+ (- e) (* e -16.720351734625446))  (+ (- -16.647842075384954) e)))
;; t3
;; (p-i t3)
;(infix-2-postfix t)

;; (require "../../ctrl/ctrl-library.rkt")
;; (define c1 (make-ctrl))
;; (define c2 (make-ctrl))
;; (define c3 (make-ctrl))
;; (define c4 (make-ctrl))
;; (define c5 (make-ctrl))
;; c1
;; (p-i c1)
(define (count-items-in-list item lista)
(define (count-integral-syms ctrl)
  ((l

 (define test '(*   (* 12.602761504560334 (tanh (* (- e) (- 19.60774011872941))))
   (- (* -18.627909513796954 -9.310109460843439))))
 (define test-i '(*   (* 12.602761504560334 (integral (* (- e) (- 19.60774011872941))))
                      (- (* -18.627909513796954 -9.310109460843439))))

(define t0 '(integral  (- e))   ) 
(define t1 '(* 10.3 (integral  (- e))) )
(cut-integral t0)
